<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro | Evento de Café</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are automatically provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables for other scripts to use
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;

        // Sign in anonymously or with custom token
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log('Signed in with custom token');
                    } else {
                        await signInAnonymously(auth);
                        console.log('Signed in anonymously');
                    }
                } catch (error) {
                    console.error('Firebase Auth Error:', error);
                }
            } else {
                 console.log('User is signed in:', user.uid);
            }
        });
    </script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: #05332C;
            color: #FFFFFF;
        }
        .title-font {
            font-family: 'Playfair Display', serif;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 2rem;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Disables user interaction with the video */
        }
        .form-container {
            background-color: #2E110C;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid #F6B744;
        }
        
        .mountain-svg {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: -1;
            width: 100%;
            height: auto;
            fill: #305826;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2));
        }

        .coffee-bean-svg {
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .suggestion-card {
            background-color: #05332C;
            border-left: 3px solid #F6B744;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-[#05332C]">
    <div class="relative min-h-screen flex items-center justify-center p-4">
        <!-- Mountain and Coffee Graphics -->
        <svg class="mountain-svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
            <path d="M0,160L48,160C96,160,192,160,288,144C384,128,480,96,576,128C672,160,768,256,864,256C960,256,1056,160,1152,128C1248,96,1344,128,1392,144L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
        </svg>
        <svg class="absolute top-10 left-10 w-20 h-20 text-[#305826] coffee-bean-svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 4.1 3.5 7.6 7 11.2 3.5-3.6 7-7.1 7-11.2 0-3.87-3.13-7-7-7zm0 14c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        <svg class="absolute bottom-10 right-10 w-20 h-20 text-[#00A97A] coffee-bean-svg" style="animation-delay: 2s;" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 4.1 3.5 7.6 7 11.2 3.5-3.6 7-7.1 7-11.2 0-3.87-3.13-7-7-7zm0 14c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        
        <div class="container">
            <p class="text-sm text-center mb-2 text-white/50">Tu ID de usuario: <span id="userIdDisplay">Cargando...</span></p>
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-center mb-6 title-font text-[#FCEAC8]">
                ¡Únete a la Celebración del Café!
            </h1>
            <p class="text-center text-lg mb-8 text-white/90">
                Regístrate ahora para el evento de reconocimiento de café. Descubre los secretos detrás de los granos más exquisitos.
            </p>

            <!-- Video Section -->
            <div class="video-container">
                <iframe 
                    src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&controls=0&loop=1&playlist=dQw4w9WgXcQ"
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>

            <!-- Registration Form -->
            <div class="form-container">
                <h2 class="text-2xl font-bold text-center mb-6 title-font text-[#F6B744]">Formulario de Registro</h2>
                <form id="registrationForm" class="space-y-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-white/90">Nombre y Apellidos</label>
                        <input type="text" id="nombre" name="nombre" required class="mt-1 block w-full rounded-md bg-[#05332C] border-gray-600 focus:border-[#F6B744] focus:ring focus:ring-[#F6B744] focus:ring-opacity-50 p-3">
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-white/90">Número de Teléfono</label>
                        <input type="tel" id="telefono" name="telefono" required class="mt-1 block w-full rounded-md bg-[#05332C] border-gray-600 focus:border-[#F6B744] focus:ring focus:ring-[#F6B744] focus:ring-opacity-50 p-3">
                    </div>
                    <div>
                        <label for="correo" class="block text-sm font-medium text-white/90">Correo Electrónico (Opcional)</label>
                        <input type="email" id="correo" name="correo" class="mt-1 block w-full rounded-md bg-[#05332C] border-gray-600 focus:border-[#F6B744] focus:ring focus:ring-[#F6B744] focus:ring-opacity-50 p-3">
                    </div>
                    
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-[#2E110C] bg-[#F6B744] hover:bg-[#FCEAC8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F6B744] transition-colors">
                        Inscribirme ahora
                    </button>
                    
                    <!-- Mensajes de estado -->
                    <div id="statusMessage" class="text-center text-sm font-medium mt-4 hidden"></div>
                </form>
            </div>

            <!-- Gemini API Features -->
            <div class="form-container mt-8">
                <h2 class="text-2xl font-bold text-center mb-6 title-font text-[#F6B744]">✨ Descubre más sobre el café ✨</h2>

                <!-- Coffee Fact Generator -->
                <div class="mb-6">
                    <button id="generateFactBtn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-[#2E110C] bg-[#FCEAC8] hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FCEAC8] transition-colors">
                        Generar un Dato Curioso sobre Café
                    </button>
                    <div id="factResult" class="mt-4 text-center italic text-[#00A97A] min-h-[2rem]"></div>
                </div>

                <!-- Coffee Pairing Suggestion -->
                <div>
                    <label for="coffeeType" class="block text-sm font-medium text-white/90">Sugerencia de Maridaje (ej: "espresso")</label>
                    <div class="flex mt-1">
                        <input type="text" id="coffeeType" class="flex-grow rounded-md bg-[#05332C] border-gray-600 focus:border-[#F6B744] focus:ring focus:ring-[#F6B744] focus:ring-opacity-50 p-3">
                        <button id="suggestPairingBtn" class="ml-2 py-3 px-4 rounded-md shadow-sm text-sm font-medium text-[#2E110C] bg-[#F6B744] hover:bg-[#FCEAC8] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F6B744] transition-colors">
                            Sugerir
                        </button>
                    </div>
                    <div id="pairingResult" class="mt-4 text-center italic text-[#00A97A] min-h-[2rem]"></div>
                </div>
            </div>

            <!-- Suggestions Section -->
            <div class="form-container mt-8">
                <h2 class="text-2xl font-bold text-center mb-6 title-font text-[#F6B744]">Comentarios y Sugerencias</h2>
                <form id="suggestionForm" class="space-y-4 mb-6">
                    <div>
                        <label for="suggestionText" class="block text-sm font-medium text-white/90">Escribe tu sugerencia</label>
                        <textarea id="suggestionText" required class="mt-1 block w-full rounded-md bg-[#05332C] border-gray-600 focus:border-[#F6B744] focus:ring focus:ring-[#F6B744] focus:ring-opacity-50 p-3" rows="3"></textarea>
                    </div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-[#2E110C] bg-[#FCEAC8] hover:bg-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#FCEAC8] transition-colors">
                        Enviar Sugerencia
                    </button>
                    <div id="suggestionStatus" class="text-center text-sm font-medium mt-4 hidden"></div>
                </form>
                
                <div id="suggestionsList" class="space-y-4">
                    <!-- Suggestions will be dynamically added here -->
                </div>
            </div>

        </div>
    </div>

    <script>
        const form = document.getElementById('registrationForm');
        const statusMessage = document.getElementById('statusMessage');

        const generateFactBtn = document.getElementById('generateFactBtn');
        const factResult = document.getElementById('factResult');
        const coffeeTypeInput = document.getElementById('coffeeType');
        const suggestPairingBtn = document.getElementById('suggestPairingBtn');
        const pairingResult = document.getElementById('pairingResult');
        
        const suggestionForm = document.getElementById('suggestionForm');
        const suggestionsList = document.getElementById('suggestionsList');
        const suggestionStatus = document.getElementById('suggestionStatus');
        
        // Ensure Firebase is initialized before proceeding
        document.addEventListener('DOMContentLoaded', () => {
            const userIdDisplay = document.getElementById('userIdDisplay');
            if (window.auth) {
                window.auth.onAuthStateChanged(user => {
                    if (user) {
                        userIdDisplay.textContent = user.uid;
                        console.log('User UID:', user.uid);
                        setupSuggestionsListener();
                    } else {
                        userIdDisplay.textContent = 'No autenticado';
                    }
                });
            } else {
                userIdDisplay.textContent = 'Cargando...';
            }
        });

        // Function to send data to Google Sheets
        async function submitToGoogleSheets(data) {
            const scriptUrl = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'; 
            
            const formData = new FormData();
            for (const key in data) {
                formData.append(key, data[key]);
            }

            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    statusMessage.textContent = '¡Registro exitoso! ¡Nos vemos pronto!';
                    statusMessage.className = 'text-center text-[#00A97A] text-sm font-medium mt-4 block';
                    form.reset();
                } else {
                    statusMessage.textContent = 'Hubo un error al registrarse. Inténtalo de nuevo.';
                    statusMessage.className = 'text-center text-red-500 text-sm font-medium mt-4 block';
                }
            } catch (error) {
                console.error('Error:', error);
                statusMessage.textContent = 'Error de conexión. Por favor, verifica tu internet e inténtalo de nuevo.';
                statusMessage.className = 'text-center text-red-500 text-sm font-medium mt-4 block';
            }
        }

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const data = {
                nombre: document.getElementById('nombre').value,
                telefono: document.getElementById('telefono').value,
                correo: document.getElementById('correo').value,
                userId: window.auth.currentUser.uid,
            };
            statusMessage.textContent = 'Registrando...';
            statusMessage.className = 'text-center text-[#F6B744] text-sm font-medium mt-4 block';
            submitToGoogleSheets(data);
        });

        // Gemini API integration
        const apiKey = "";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        async function generateCoffeeFact() {
            factResult.textContent = 'Generando...';
            const prompt = "Dame un dato curioso e interesante sobre el café. La respuesta debe ser concisa, en una sola frase y en español.";
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar el dato. Intenta de nuevo.";
                factResult.textContent = text;
            } catch (error) {
                factResult.textContent = 'Error al generar el dato. Intenta de nuevo.';
                console.error('Error:', error);
            }
        }

        async function suggestPairing() {
            const coffeeType = coffeeTypeInput.value.trim();
            if (!coffeeType) {
                pairingResult.textContent = 'Por favor, introduce un tipo de café.';
                return;
            }
            pairingResult.textContent = 'Buscando sugerencias...';
            const prompt = `Sugiere un maridaje de comida para el siguiente tipo de café: ${coffeeType}. Responde de forma concisa y en una sola frase en español.`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar la sugerencia. Intenta de nuevo.";
                pairingResult.textContent = text;
            } catch (error) {
                pairingResult.textContent = 'Error al generar la sugerencia. Intenta de nuevo.';
                console.error('Error:', error);
            }
        }

        generateFactBtn.addEventListener('click', generateCoffeeFact);
        suggestPairingBtn.addEventListener('click', suggestPairing);
        
        // --- Firestore Suggestions Logic ---
        function setupSuggestionsListener() {
            const db = window.db;
            const appId = window.appId;
            const suggestionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');
            const q = query(suggestionsRef); // No need for orderBy to avoid potential index issues
            
            onSnapshot(q, (querySnapshot) => {
                suggestionsList.innerHTML = '';
                const suggestions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    suggestions.push(data);
                });
                
                // Sort by timestamp in memory to avoid Firebase index issues
                suggestions.sort((a, b) => b.timestamp - a.timestamp);

                suggestions.forEach(suggestion => {
                    const suggestionElement = document.createElement('div');
                    suggestionElement.className = 'suggestion-card';
                    const suggestionText = document.createElement('p');
                    suggestionText.textContent = suggestion.text;
                    suggestionText.className = 'text-white/90';
                    suggestionElement.appendChild(suggestionText);
                    suggestionsList.appendChild(suggestionElement);
                });
            });
        }
        
        suggestionForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const db = window.db;
            const appId = window.appId;
            const suggestionText = document.getElementById('suggestionText').value;
            
            if (!suggestionText.trim()) {
                suggestionStatus.textContent = 'La sugerencia no puede estar vacía.';
                suggestionStatus.className = 'text-center text-red-500 text-sm font-medium mt-4 block';
                return;
            }
            
            const suggestionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');
            
            suggestionStatus.textContent = 'Enviando...';
            suggestionStatus.className = 'text-center text-[#F6B744] text-sm font-medium mt-4 block';
            
            try {
                await addDoc(suggestionsRef, {
                    text: suggestionText,
                    timestamp: Date.now(),
                    userId: window.auth.currentUser.uid
                });
                document.getElementById('suggestionText').value = '';
                suggestionStatus.textContent = '¡Sugerencia enviada! Se mostrará en la lista.';
                suggestionStatus.className = 'text-center text-[#00A97A] text-sm font-medium mt-4 block';
            } catch (e) {
                console.error("Error adding document: ", e);
                suggestionStatus.textContent = 'Hubo un error al enviar la sugerencia.';
                suggestionStatus.className = 'text-center text-red-500 text-sm font-medium mt-4 block';
            }
        });
        
        function setVideoSource() {
            const iframe = document.querySelector('iframe');
            const videoId = "T0KgT5gF3oI"; 
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&controls=0&loop=1&playlist=${videoId}`;
        }
        
        window.onload = setVideoSource;

    </script>
</body>
</html>
```
eof

### **Instrucciones Importantes para la Versión Mejorada**

1.  **Reemplaza Todo el Código:** Copia todo el código que te di arriba y reemplaza por completo el contenido de tu archivo `index.html`.

2.  **No Necesitas Editar la Configuración de la Base de Datos:** Las variables de Firebase (`__app_id`, `__firebase_config`, etc.) se manejan automáticamente. No necesitas editar nada en la sección de `Firebase Libraries`.

3.  **Actualiza tu Google Sheets Script:** Como ahora el formulario de registro también guarda el ID del usuario, debes actualizar el script en Google Apps para que capture este nuevo campo.

    * Ve a **Google Apps Script** (donde pegaste el código la última vez).
    * Reemplaza el código anterior con este nuevo código:
    ```javascript
    function doPost(e) {
      // Reemplaza 'NombreDeTuHoja' con el nombre de tu hoja de cálculo, por ejemplo: 'Registro'
      var sheetName = 'NombreDeTuHoja'; 
      var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
      
      var data = e.parameter;
      var newRow = [
        new Date(),
        data.nombre,
        data.telefono,
        data.correo,
        data.userId // Nuevo campo
      ];
      
      sheet.appendRow(newRow);
      
      return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
    }
    